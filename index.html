function validateAndStart() {
            state.participantId = document.getElementById('participantId').value.trim().toUpperCase();
            state.participantEmail = document.getElementById('participantEmail').value.trim();
            state.selectedTrial = document.getElementById('trialSelect').value;
            state.demographics.listeningDevice = document.getElementById('listeningDevice').value;
            state.demographics.musicBackground = document.getElementById('musicBackground').value;
            state.demographics.languageBackground = document.getElementById('languageBackground').value;
            state.demographics.firstLanguage = document.getElementById('firstLanguage').value.trim();
            state.demographics.otherLanguages = document.getElementById('otherLanguages').value.trim();
            state.demographics.age = document.getElementById('age').value;

            if (!state.participantId) {
                alert('Please enter a participant ID');
                return;
            }
            
            if (!state.participantEmail) {
                alert('Please enter your email address');
                return;
            }
            
            // Validate participant ID and email match
            if (!state.participantAssignments || !state.participantAssignments.participants[state.participantId]) {
                alert('Invalid Participant ID. Please verify your ID and email.');
                return;
            }
            
            const participant = state.participantAssignments.participants[state.participantId];
            if (participant.email.toLowerCase() !== state.participantEmail.toLowerCase()) {
                alert('Email address does not match the Participant ID. Please check both entries.');
                return;
            }
            
            if (!state.selectedTrial) {
                alert('Please select a trial');
                return;
            }
            
            // Validate trial is assigned to this participant
            if (!participant.assignedTrials.includes(state.selectedTrial)) {
                alert('This trial is not assigned to you. Please select from your assigned trials.');
                return;
            }
            
            if (!state.demographics.listeningDevice) {
                alert('Please select your listening device');
                return;
            }
            if (!state.demographics.musicBackground) {
                alert('Please indicate if you have a music background');
                return;
            }
            if (!state.demographics.languageBackground) {
                alert('Please select your language background');
                return;
            }
            if (state.demographics.languageBackground === 'non-native' && !state.demographics.firstLanguage) {
                alert('Please enter your first language');
                return;
            }
            if (!state.demographics.otherLanguages) {
                alert('Please list the languages you speak');
                <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Perception Listening Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading-bar {
            transition: width 0.3s ease;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-50 min-h-screen">
    <div id="app"></div>

    <script>
        // ============= CONFIGURATION - UPDATE THESE =============
        
        // Google Form Pre-filled URL Template
        // Get this from: Google Form ‚Üí ‚ãÆ menu ‚Üí Get pre-filled link
        // Use these EXACT placeholders: PARTICIPANT_ID, TRIAL_NAME, LISTENING_DEVICE,
        // MUSIC_BACKGROUND, LANGUAGE_BACKGROUND, FIRST_LANGUAGE, OTHER_LANGUAGES, AGE
	const GOOGLE_FORM_TEMPLATE = "https://docs.google.com/forms/d/e/1FAIpQLSd_MLDI7vuQN1c70_o5-szCioVbmrUKUKpHhtInxQ0tCnGREQ/viewform?usp=pp_url&entry.16675421=PARTICIPANT_ID&entry.1243735317=PARTICIPANT_EMAIL&entry.623538109=TRIAL_NAME&entry.1036755193=LISTENING_DEVICE&entry.1172676033=MUSIC_BACKGROUND&entry.1771353994=LANGUAGE_BACKGROUND&entry.1783695746=FIRST_LANGUAGE&entry.1207484341=OTHER_LANGUAGES&entry.1419101100=AGE";

        // GitHub repository details
        const CONFIG = {
            githubUser: 'yttehs',
            githubRepo: 'Listening_Test',
            githubBranch: 'main',
            participantAssignmentsFile: 'participant_assignments.json'
        };

        // ========================================================

        function getPrefilledFormURL() {
            return GOOGLE_FORM_TEMPLATE
                .replace('PARTICIPANT_ID', encodeURIComponent(state.participantId))
                .replace('TRIAL_NAME', encodeURIComponent(state.selectedTrial))
                .replace('LISTENING_DEVICE', encodeURIComponent(state.demographics.listeningDevice))
                .replace('MUSIC_BACKGROUND', encodeURIComponent(state.demographics.musicBackground))
                .replace('LANGUAGE_BACKGROUND', encodeURIComponent(state.demographics.languageBackground))
                .replace('FIRST_LANGUAGE', encodeURIComponent(state.demographics.firstLanguage || 'N/A'))
                .replace('OTHER_LANGUAGES', encodeURIComponent(state.demographics.otherLanguages))
                .replace('AGE', encodeURIComponent(state.demographics.age));
        }

        // State management
        let state = {
            stage: 'start',
            participantId: '',
            participantEmail: '',
            selectedTrial: '',
            availableTrials: [],
            participantAssignments: null,
            demographics: {
                listeningDevice: '',
                musicBackground: '',
                languageBackground: '',
                firstLanguage: '',
                otherLanguages: '',
                age: ''
            },
            audioMapping: [],
            positions: {},
            playing: null,
            dragging: null,
            hovering: null,
            loadingProgress: 0,
            loadingMessage: 'Initializing...',
            audioContext: null,
            audioBuffers: {},
            currentSource: null
        };

        const canvasSize = Math.min(window.innerWidth - 100, 800);

        // Initialize
        async function initialize() {
            try {
                const assignmentsUrl = `https://raw.githubusercontent.com/${CONFIG.githubUser}/${CONFIG.githubRepo}/${CONFIG.githubBranch}/${CONFIG.participantAssignmentsFile}`;
                const response = await fetch(assignmentsUrl);
                
                if (response.ok) {
                    state.participantAssignments = await response.json();
                } else {
                    console.error('Could not load participant assignments');
                    state.participantAssignments = { participants: {}, trialInfo: {} };
                }
            } catch (error) {
                console.error('Error loading participant assignments:', error);
                state.participantAssignments = { participants: {}, trialInfo: {} };
            }
            render();
        }

        function loadTrialsForParticipant(participantId, email) {
            if (!state.participantAssignments) {
                return [];
            }

            const participant = state.participantAssignments.participants[participantId.toUpperCase()];
            
            if (!participant) {
                return [];
            }

            // Verify email matches (case-insensitive)
            if (participant.email.toLowerCase() !== email.toLowerCase()) {
                return [];
            }

            // Map assigned trial IDs to trial objects with display info
            return participant.assignedTrials.map(trialId => {
                const trialInfo = state.participantAssignments.trialInfo[trialId];
                return {
                    id: trialId,
                    name: trialInfo && trialInfo.displayName ? trialInfo.displayName : trialId.replace(/_/g, " "),
                    numFiles: trialInfo ? trialInfo.numFiles : 24
                };
            });
        }

        function checkParticipantId() {
            const participantInput = document.getElementById('participantId');
            const emailInput = document.getElementById('participantEmail');
            const trialSelectDiv = document.getElementById('trialSelectDiv');
            const trialSelect = document.getElementById('trialSelect');
            const participantError = document.getElementById('participantError');
            
            const participantId = participantInput.value.trim().toUpperCase();
            const email = emailInput.value.trim();
            
            console.log('Checking participant ID:', participantId, 'with email:', email);
            console.log('Participant assignments loaded:', state.participantAssignments ? 'Yes' : 'No');
            
            if (!participantId || !email) {
                trialSelectDiv.style.display = 'none';
                participantError.style.display = 'none';
                return;
            }

            if (!state.participantAssignments || !state.participantAssignments.participants) {
                participantError.style.display = 'block';
                participantError.innerHTML = `
                    <div class="p-3 bg-red-50 border border-red-300 rounded-lg text-sm text-red-800">
                        <strong>Error:</strong> Participant assignments file not loaded. Please refresh the page or contact the researcher.
                    </div>
                `;
                trialSelectDiv.style.display = 'none';
                return;
            }

            const assignedTrials = loadTrialsForParticipant(participantId, email);
            
            console.log('Assigned trials for', participantId, ':', assignedTrials);
            
            if (assignedTrials.length === 0) {
                participantError.style.display = 'block';
                participantError.innerHTML = `
                    <div class="p-3 bg-red-50 border border-red-300 rounded-lg text-sm text-red-800">
                        <strong>Authentication Failed:</strong> Participant ID "${participantId}" and email "${email}" do not match our records. Please check both entries or contact the researcher.
                    </div>
                `;
                trialSelectDiv.style.display = 'none';
                state.availableTrials = [];
            } else {
                participantError.style.display = 'none';
                trialSelectDiv.style.display = 'block';
                state.availableTrials = assignedTrials;
                state.participantEmail = email; // Store validated email
                
                // Update dropdown
                const trialsOptions = assignedTrials.map(trial => 
                    `<option value="${trial.id}">${trial.name} (${trial.numFiles} samples)</option>`
                ).join('');
                trialSelect.innerHTML = '<option value="">-- Select a trial --</option>' + trialsOptions;
                
                console.log('Updated trial dropdown with', assignedTrials.length, 'trials');
            }
        }

        function render() {
            const app = document.getElementById('app');
            
            switch(state.stage) {
                case 'start':
                    app.innerHTML = renderStart();
                    break;
                case 'loading':
                    app.innerHTML = renderLoading();
                    break;
                case 'instructions':
                    app.innerHTML = renderInstructions();
                    break;
                case 'test':
                    app.innerHTML = renderTest();
                    setTimeout(drawCanvas, 0);
                    break;
                case 'complete':
                    app.innerHTML = renderComplete();
                    break;
            }
        }

        function renderStart() {
            return `
                <div class="p-8">
                    <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-8">
                        <h1 class="text-3xl font-bold text-gray-800 mb-6">Voice Perception Listening Test</h1>
                        
                        <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                            <div class="flex items-start gap-3">
                                <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div class="text-sm text-gray-700">
                                    <p class="font-semibold mb-2">Welcome!</p>
                                    <p class="mb-2">In this test, you will listen to voice samples and arrange them in a 2D space based on how similar they sound to you.</p>
                                    <p>The test will take approximately 15-20 minutes to complete.</p>
                                </div>
                            </div>
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Participant ID *</label>
                            <input 
                                type="text" 
                                id="participantId" 
                                value="${state.participantId}" 
                                placeholder="Enter your participant ID (e.g., P001)" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                            />
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email Address *</label>
                            <input 
                                type="email" 
                                id="participantEmail" 
                                value="${state.participantEmail}" 
                                placeholder="Enter your email address" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                            />
                            <p class="text-xs text-gray-500 mt-1">Use the same email provided by the researcher</p>
                        </div>

                        <button 
                            onclick="checkParticipantId()" 
                            class="mb-6 px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-medium"
                        >
                            Verify & Load Trials
                        </button>

                        <div id="participantError" style="display: none;" class="mb-6"></div>

                        <div id="trialSelectDiv" style="display: none;" class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Select Trial *</label>
                            <select id="trialSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                <option value="">-- Select a trial --</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-2">These are the trials assigned to you.</p>
                        </div>

                        <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-300">
                            <h3 class="font-semibold text-gray-800 mb-4">Background Information</h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Listening Device *</label>
                                    <select id="listeningDevice" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                        <option value="">-- Select --</option>
                                        <option value="headphones">Headphones</option>
                                        <option value="earphones">Earphones</option>
                                        <option value="speakers">Speakers</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Do you have a background in music? *</label>
                                    <select id="musicBackground" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                        <option value="">-- Select --</option>
                                        <option value="yes">Yes</option>
                                        <option value="no">No</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Language Background *</label>
                                    <select id="languageBackground" onchange="toggleFirstLanguage()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                        <option value="">-- Select --</option>
                                        <option value="native">Native English Speaker</option>
                                        <option value="non-native">Non-Native English Speaker</option>
                                    </select>
                                </div>

                                <div id="firstLanguageDiv" style="display: none;">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">What is your first language? *</label>
                                    <input type="text" id="firstLanguage" placeholder="e.g., Spanish, Mandarin, Hindi" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"/>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">What languages do you speak? *</label>
                                    <input type="text" id="otherLanguages" placeholder="e.g., English, Spanish, French" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"/>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Age *</label>
                                    <input type="number" id="age" placeholder="Enter your age" min="18" max="100" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"/>
                                </div>
                            </div>
                        </div>

                        <button onclick="validateAndStart()" id="loadButton" class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition-colors font-medium">
                            Load Audio Files & Continue
                        </button>
                    </div>
                </div>
            `;
        }

        function toggleFirstLanguage() {
            const langBg = document.getElementById('languageBackground').value;
            const firstLangDiv = document.getElementById('firstLanguageDiv');
            firstLangDiv.style.display = langBg === 'non-native' ? 'block' : 'none';
        }

        function validateAndStart() {
            state.participantId = document.getElementById('participantId').value.trim().toUpperCase();
            state.selectedTrial = document.getElementById('trialSelect').value;
            state.demographics.listeningDevice = document.getElementById('listeningDevice').value;
            state.demographics.musicBackground = document.getElementById('musicBackground').value;
            state.demographics.languageBackground = document.getElementById('languageBackground').value;
            state.demographics.firstLanguage = document.getElementById('firstLanguage').value.trim();
            state.demographics.otherLanguages = document.getElementById('otherLanguages').value.trim();
            state.demographics.age = document.getElementById('age').value;

            if (!state.participantId) {
                alert('Please enter a participant ID');
                return;
            }
            
            // Validate participant ID exists
            if (!state.participantAssignments || !state.participantAssignments.participants[state.participantId]) {
                alert('Invalid Participant ID. Please check your ID or contact the researcher.');
                return;
            }
            
            if (!state.selectedTrial) {
                alert('Please select a trial');
                return;
            }
            
            // Validate trial is assigned to this participant
            const participant = state.participantAssignments.participants[state.participantId];
            if (!participant.assignedTrials.includes(state.selectedTrial)) {
                alert('This trial is not assigned to you. Please select from your assigned trials.');
                return;
            }
            
            if (!state.demographics.listeningDevice) {
                alert('Please select your listening device');
                return;
            }
            if (!state.demographics.musicBackground) {
                alert('Please indicate if you have a music background');
                return;
            }
            if (!state.demographics.languageBackground) {
                alert('Please select your language background');
                return;
            }
            if (state.demographics.languageBackground === 'non-native' && !state.demographics.firstLanguage) {
                alert('Please enter your first language');
                return;
            }
            if (!state.demographics.otherLanguages) {
                alert('Please list the languages you speak');
                return;
            }
            if (!state.demographics.age || state.demographics.age < 18) {
                alert('Please enter a valid age (18 or older)');
                return;
            }

            startLoading();
        }

        function renderLoading() {
            return `
                <div class="p-8 flex items-center justify-center min-h-screen">
                    <div class="max-w-md mx-auto bg-white rounded-xl shadow-lg p-8 text-center">
                        <svg class="w-16 h-16 text-indigo-600 mx-auto mb-4 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path>
                        </svg>
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">${state.loadingMessage}</h2>
                        <div class="w-full bg-gray-200 rounded-full h-4 mb-2">
                            <div class="loading-bar bg-indigo-600 h-4 rounded-full" style="width: ${state.loadingProgress}%"></div>
                        </div>
                        <p class="text-gray-600">${state.loadingProgress}% complete</p>
                        <p class="text-sm text-gray-500 mt-4">Please wait while we load the voice samples...</p>
                        <p class="text-sm font-medium text-indigo-600 mt-2">Trial: ${state.selectedTrial.replace(/_/g, " ")}</p>
                    </div>
                </div>
            `;
        }

        function renderInstructions() {
            const numSamples = state.audioMapping.length;
            
            return `
                <div class="p-8">
                    <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-lg p-8">
                        <div class="mb-4 p-3 bg-indigo-100 rounded-lg">
                            <p class="text-sm font-medium text-indigo-800">
                                Trial: ${state.selectedTrial.replace(/_/g, " ")} | Participant: ${state.participantId}
                            </p>
                        </div>

                        <h1 class="text-3xl font-bold text-gray-800 mb-6">Test Instructions</h1>
                        
                        <div class="space-y-4 text-gray-700 mb-8">
                            <div class="p-4 bg-red-50 rounded-lg border-2 border-red-300">
                                <h3 class="font-semibold text-red-900 mb-2">‚ö†Ô∏è Important Listening Environment</h3>
                                <ul class="list-disc list-inside space-y-1 text-sm">
                                    <li><strong>Take this test in a quiet room</strong> with minimal background noise</li>
                                    <li>Ensure your ${state.demographics.listeningDevice} are properly connected and working</li>
                                    <li><strong>Set your volume to a comfortable level at the start</strong> and keep it constant throughout the test</li>
                                    <li><strong>Listen to all voices at the same volume</strong> - do not adjust volume between samples</li>
                                </ul>
                            </div>

                            <div class="p-4 bg-yellow-50 rounded-lg border-2 border-yellow-300">
                                <h3 class="font-semibold text-yellow-900 mb-2">üéØ What to Focus On</h3>
                                <p class="text-sm mb-2">
                                    <strong>Your task is to judge how the voices SOUND, not what they are saying.</strong>
                                </p>
                                <ul class="list-disc list-inside space-y-1 text-sm">
                                    <li>The voice samples may be incomplete sentence fragments (1-1.5 seconds long)</li>
                                    <li>Focus on voice quality, tone, pitch, and overall sound characteristics</li>
                                    <li><strong>Ignore the linguistic content</strong> - different speakers may say different things</li>
                                    <li>Base your judgments purely on acoustic similarity of the voices</li>
                                </ul>
                            </div>

                            <div class="p-4 bg-indigo-50 rounded-lg">
                                <h2 class="font-semibold text-lg mb-2">Your Task:</h2>
                                <p>You will arrange ${numSamples} voice samples (numbered 1-${numSamples}) in a 2D space based on how similar they sound to you.</p>
                            </div>

                            <div class="p-4 bg-gray-50 rounded-lg">
                                <h3 class="font-semibold mb-2">How to arrange voices:</h3>
                                <ul class="list-disc list-inside space-y-2">
                                    <li><strong>Similar-sounding voices</strong> ‚Üí Place them close together (can even overlap)</li>
                                    <li><strong>Different-sounding voices</strong> ‚Üí Place them far apart</li>
                                    <li><strong>Use the entire space</strong> - spread voices across the full canvas area</li>
                                    <li>If voices sound very similar, you can place them on top of each other</li>
                                </ul>
                            </div>

                            <div class="p-4 bg-gray-50 rounded-lg">
                                <h3 class="font-semibold mb-2">Controls:</h3>
                                <ul class="list-disc list-inside space-y-2">
                                    <li><strong>Click</strong> a numbered circle to play that voice sample</li>
                                    <li><strong>Drag</strong> circles to reposition them in the space</li>
                                    <li>The circle turns <span class="text-green-600 font-semibold">green</span> when playing audio</li>
                                    <li>Listen to samples as many times as you need</li>
                                    <li>Take your time - there are no wrong answers</li>
                                </ul>
                            </div>

                            <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                                <p class="text-sm">
                                    <strong>Remember:</strong> Your perception is subjective and valuable. 
                                    Arrange the voices based on how they SOUND to YOU, not what they are saying.
                                </p>
                            </div>
                        </div>

                        <button onclick="startTest()" class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition-colors font-medium text-lg">
                            Start Test
                        </button>
                    </div>
                </div>
            `;
        }

        function renderTest() {
            return `
                <div class="p-8">
                    <div class="max-w-6xl mx-auto">
                        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h1 class="text-2xl font-bold text-gray-800">Voice Arrangement Task</h1>
                                    <p class="text-gray-600">Participant: ${state.participantId} | Trial: ${state.selectedTrial.replace(/_/g, " ")}</p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="resetPositions()" class="flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                        Reset
                                    </button>
                                    <button onclick="completeTest()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium">
                                        Complete Test
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="mb-4 p-3 bg-blue-50 rounded-lg">
                                <p class="text-sm text-gray-700">
                                    <strong>Click</strong> circles to play audio ‚Ä¢ <strong>Drag</strong> circles to arrange ‚Ä¢ 
                                    <span class="ml-2 inline-flex items-center gap-1">
                                        <span class="w-3 h-3 bg-green-500 rounded-full"></span> = Playing
                                    </span>
                                </p>
                            </div>
                            
                            <canvas id="canvas" width="${canvasSize}" height="${canvasSize}" class="cursor-pointer border border-gray-300 rounded-lg mx-auto block"></canvas>
                            <p class="text-sm text-gray-500 mt-4 text-center">
                                Similar voices should be close together. Different voices should be far apart.
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderComplete() {
            return `
                <div class="p-8">
                    <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-8">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <h1 class="text-3xl font-bold text-gray-800 mb-2">Test Complete!</h1>
                            <p class="text-gray-600">Thank you for completing the test, ${state.participantId}</p>
                            <p class="text-sm text-gray-500 mt-2">Trial: ${state.selectedTrial.replace(/_/g, " ")}</p>
                        </div>

                        <div class="space-y-4">
                            <div class="p-4 bg-gray-50 rounded-lg">
                                <h2 class="font-semibold mb-2">Results Summary:</h2>
                                <ul class="text-sm text-gray-700 space-y-1">
                                    <li>‚Ä¢ Voice samples arranged: ${state.audioMapping.length}</li>
                                    <li>‚Ä¢ Unique pairwise distances: ${(state.audioMapping.length * (state.audioMapping.length - 1)) / 2}</li>
                                    <li>‚Ä¢ Coordinates normalized to 0-1 scale</li>
                                </ul>
                            </div>

                            <div class="p-4 bg-blue-50 rounded-lg border-2 border-blue-300">
                                <h3 class="font-semibold text-blue-900 mb-3">üì§ Submit Your Results</h3>
                                <p class="text-sm text-gray-700 mb-3">
                                    Please follow these steps to submit your results:
                                </p>
                                <ol class="text-sm text-gray-700 space-y-2 mb-4 list-decimal list-inside">
                                    <li><strong>Download both files</strong> using the buttons below</li>
                                    <li><strong>Open the pre-filled submission form</strong> (your info is already filled in!)</li>
                                    <li><strong>Upload both files</strong> to the form and submit</li>
                                </ol>
                                
                                <div class="space-y-2 mb-4">
                                    <button
                                        onclick="exportResults()"
                                        class="w-full flex items-center justify-center gap-2 bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition-colors font-medium"
                                    >
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                        </svg>
                                        1. Download JSON File
                                    </button>
                                    
                                    <button
                                        onclick="exportCSV()"
                                        class="w-full flex items-center justify-center gap-2 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors font-medium"
                                    >
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                        </svg>
                                        2. Download CSV File
                                    </button>
                                </div>

                                <button
                                    onclick="window.open(getPrefilledFormURL(), '_blank')"
                                    class="w-full flex items-center justify-center gap-2 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium"
                                >
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    3. Open Submission Form (Pre-filled)
                                </button>
                            </div>

                            <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                                <p class="text-sm text-gray-700">
                                    <strong>Note:</strong> Your information will be automatically filled in the form. You only need to upload the two files!
                                </p>
                            </div>

                            <div class="pt-4 border-t border-gray-200">
                                <button
                                    onclick="window.location.reload()"
                                    class="w-full text-indigo-600 hover:text-indigo-800 transition-colors py-2 font-medium"
                                >
                                    Complete Another Trial
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Core functions
        async function startLoading() {
            state.stage = 'loading';
            render();

            try {
                await loadConfiguration();
                await loadAudioFiles();
                initializePositions();
                state.stage = 'instructions';
                render();
            } catch (error) {
                console.error('Error during loading:', error);
                alert('Error loading audio files. Please check your internet connection and try again.\n\nError: ' + error.message);
                state.stage = 'start';
                render();
            }
        }

        async function loadConfiguration() {
            state.loadingMessage = 'Loading configuration...';
            render();

            const configUrl = `https://raw.githubusercontent.com/${CONFIG.githubUser}/${CONFIG.githubRepo}/${CONFIG.githubBranch}/${state.selectedTrial}/config.json`;
            
            const response = await fetch(configUrl);
            if (!response.ok) {
                throw new Error(`Configuration file not found for trial: ${state.selectedTrial}`);
            }
            
            const config = await response.json();
            state.audioMapping = config.audioFiles;
        }

        async function loadAudioFiles() {
            state.loadingMessage = 'Loading audio files...';
            
            if (!state.audioContext) {
                state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            for (let idx = 0; idx < state.audioMapping.length; idx++) {
                const audioUrl = state.audioMapping[idx].url;
                const response = await fetch(audioUrl);
                
                if (!response.ok) {
                    throw new Error(`Failed to load ${state.audioMapping[idx].filename}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await state.audioContext.decodeAudioData(arrayBuffer);
                state.audioBuffers[idx] = audioBuffer;
                
                state.loadingProgress = Math.round(((idx + 1) / state.audioMapping.length) * 100);
                render();
            }
        }

        function initializePositions() {
            state.positions = {};
            for (let i = 0; i < state.audioMapping.length; i++) {
                state.positions[i] = {
                    x: 0.1 + Math.random() * 0.8,
                    y: 0.1 + Math.random() * 0.8
                };
            }
        }

        function startTest() {
            state.stage = 'test';
            render();
            setupCanvas();
        }

        function setupCanvas() {
            const canvas = document.getElementById('canvas');
            if (!canvas) return;

            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', handleMouseUp);
            canvas.addEventListener('mouseleave', handleMouseUp);
        }

        function handleMouseDown(e) {
            const canvas = document.getElementById('canvas');
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) / rect.width;
            const y = (e.clientY - rect.top) / rect.height;
            
            for (let i = 0; i < state.audioMapping.length; i++) {
                const pos = state.positions[i];
                const dist = Math.sqrt(Math.pow(x - pos.x, 2) + Math.pow(y - pos.y, 2));
                if (dist < 0.025) {
                    setTimeout(() => {
                        if (state.dragging === null) {
                            togglePlay(i);
                        }
                    }, 100);
                    state.dragging = i;
                    return;
                }
            }
        }

        function handleMouseMove(e) {
            const canvas = document.getElementById('canvas');
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) / rect.width;
            const y = (e.clientY - rect.top) / rect.height;

            if (state.dragging !== null) {
                const clampedX = Math.max(0, Math.min(1, x));
                const clampedY = Math.max(0, Math.min(1, y));
                state.positions[state.dragging] = { x: clampedX, y: clampedY };
                drawCanvas();
            } else {
                let hoverFound = null;
                for (let i = 0; i < state.audioMapping.length; i++) {
                    const pos = state.positions[i];
                    const dist = Math.sqrt(Math.pow(x - pos.x, 2) + Math.pow(y - pos.y, 2));
                    if (dist < 0.025) {
                        hoverFound = i;
                        break;
                    }
                }
                if (state.hovering !== hoverFound) {
                    state.hovering = hoverFound;
                    drawCanvas();
                }
            }
        }

        function handleMouseUp() {
            state.dragging = null;
        }

        function togglePlay(id) {
            if (state.currentSource) {
                state.currentSource.stop();
                state.currentSource = null;
            }

            if (state.playing === id) {
                state.playing = null;
                drawCanvas();
                return;
            }

            const audioBuffer = state.audioBuffers[id];
            if (!audioBuffer) return;

            const source = state.audioContext.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(state.audioContext.destination);
            
            source.onended = () => {
                state.playing = null;
                state.currentSource = null;
                drawCanvas();
            };

            source.start(0);
            state.currentSource = source;
            state.playing = id;
            drawCanvas();
        }

        function drawCanvas() {
            const canvas = document.getElementById('canvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw border only (no grid)
            ctx.strokeStyle = '#9ca3af';
            ctx.lineWidth = 2;
            ctx.strokeRect(0, 0, canvas.width, canvas.height);
            
            // Draw circles
            for (let i = 0; i < state.audioMapping.length; i++) {
                const pos = state.positions[i];
                const x = pos.x * canvas.width;
                const y = pos.y * canvas.height;
                
                let fillColor = '#6366f1';
                if (state.playing === i) {
                    fillColor = '#10b981';
                } else if (state.dragging === i) {
                    fillColor = '#3b82f6';
                } else if (state.hovering === i) {
                    fillColor = '#818cf8';
                }
                
                ctx.fillStyle = fillColor;
                ctx.beginPath();
                ctx.arc(x, y, 25, 0, 2 * Math.PI);
                ctx.fill();
                
                ctx.fillStyle = 'white';
                ctx.font = 'bold 16px sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(i + 1, x, y);
            }
        }

        function resetPositions() {
            initializePositions();
            drawCanvas();
        }

        function completeTest() {
            if (state.currentSource) {
                state.currentSource.stop();
                state.currentSource = null;
            }
            state.stage = 'complete';
            render();
        }

        function calculateDistances() {
            const distances = [];
            for (let i = 0; i < state.audioMapping.length; i++) {
                for (let j = i + 1; j < state.audioMapping.length; j++) {
                    const pos1 = state.positions[i];
                    const pos2 = state.positions[j];
                    const dist = Math.sqrt(
                        Math.pow(pos2.x - pos1.x, 2) + Math.pow(pos2.y - pos1.y, 2)
                    );
                    distances.push({
                        voice1: i + 1,
                        voice2: j + 1,
                        distance: dist.toFixed(6)
                    });
                }
            }
            return distances;
        }

        function exportResults() {
            const results = {
                participantId: state.participantId,
                participantEmail: state.participantEmail,
                trialId: state.selectedTrial,
                timestamp: new Date().toISOString(),
                demographics: state.demographics,
                positions: state.audioMapping.map((audio, i) => ({
                    circle: i + 1,
                    filename: audio.filename,
                    x: state.positions[i].x.toFixed(6),
                    y: state.positions[i].y.toFixed(6)
                })),
                distances: calculateDistances()
            };
            
            const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `voice_perception_${state.participantId}_${state.selectedTrial}_${Date.now()}.json`;
            a.click();
        }

        function exportCSV() {
            const distances = calculateDistances();
            const csv = [
                'Participant ID,Trial ID,Voice 1,Voice 2,Distance',
                ...distances.map(d => `${state.participantId},${state.selectedTrial},${d.voice1},${d.voice2},${d.distance}`)
            ].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `voice_perception_${state.participantId}_${state.selectedTrial}_${Date.now()}.csv`;
            a.click();
        }

        initialize();
    </script>
</body>
</html>
